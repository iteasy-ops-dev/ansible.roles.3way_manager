#!/bin/bash

# ì…ë ¥ ë³€ìˆ˜
# $1: ì‚¬ìš©ì ê³„ì • ì´ë¦„
# $2: DB ì´ë¦„
# $3: DB ì‚¬ìš©ì ê³„ì •
# $4: DB root ì‚¬ìš©ì ì´ë¦„
# $5: DB root ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸

# 24 ì„œë²„ path mysql ì„¤ì •
export PATH=$PATH:/usr/local/mysql/bin

# ë³€ìˆ˜ ì„ ì–¸
USER_ACCOUNT="$1"
DB_NAME="$2"
DB_USER="$3"
DB_ROOT_USER="$4"
DB_ROOT_PASSWORD="$5"

BIN="/usr/local/apache/bin/apachectl"
HOME_DIR="/home"
VHOST_CONF_NAME="/usr/local/apache/conf/vhosts.conf"
CBAND_CONF_NAME="/usr/local/apache/conf/cband.conf"
SSL_CONF_NAME="/usr/local/apache/conf/ssl.conf"
LOG_DIR="/usr/local/apache/logs/vhosts/$USER_ACCOUNT"
CURRENT_DATE=$(date +"%Y-%m-%d")
MYSQL_BIN=$(which mysql)

# ë””ë²„ê¹…ìš© ì¶œë ¥
echo "=== âœ… ì…ë ¥ ë³€ìˆ˜ í™•ì¸ ==="
echo "USER_ACCOUNT: $USER_ACCOUNT"
echo "DB_NAME: $DB_NAME"
echo "DB_USER: $DB_USER"
echo "DB_ROOT_USER: $DB_ROOT_USER"
echo "DB_ROOT_PASSWORD: $DB_ROOT_PASSWORD"
echo "VHOST_CONF_NAME: $VHOST_CONF_NAME"
echo "CBAND_CONF_NAME: $CBAND_CONF_NAME"
echo "SSL_CONF_NAME: $SSL_CONF_NAME"
echo "LOG_DIR: $LOG_DIR"
echo "BIN: $BIN"
echo "MYSQL_BIN: $MYSQL_BIN"
echo "CURRENT_DATE: $CURRENT_DATE"
echo "===================="

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     í•¨ ìˆ˜                                 #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# ë°°ì—´ì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ ì‘ì€ ìˆ«ì ì¤‘ ê°€ì¥ í° ìˆ˜ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
find_closest_smaller() {
  local number=$1
  shift
  local closest=-1

  for num in "$@"; do
    if [ $num -lt $number ] && { [ $closest -eq -1 ] || [ $num -gt $closest ]; }; then
      closest=$num
    fi
  done

  echo $closest
}

# ë°°ì—´ì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ í° ìˆ«ì ì¤‘ ê°€ì¥ ì‘ì€ ìˆ˜ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
find_closest_larger() {
  local number=$1
  shift
  local closest=-1

  for num in "$@"; do
    if [ $num -gt $number ] && { [ $closest -eq -1 ] || [ $num -lt $closest ]; }; then
      closest=$num
    fi
  done

  echo $closest
}
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     í•¨ ìˆ˜                                 #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     DB ì‚­ì œì²˜ë¦¬                           #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# MySQL ì ‘ì† í™•ì¸
if [[ -n $DB_NAME && -n $DB_USER && -n $DB_ROOT_USER && -n $DB_ROOT_PASSWORD ]]; then
  echo "MySQL ì ‘ì† í™•ì¸ ì¤‘..."
  $MYSQL_BIN -u "$DB_ROOT_USER" -p"$DB_ROOT_PASSWORD" -e "exit"
  if [ $? -ne 0 ]; then
    echo "âŒ MySQL ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. root ê³„ì • ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
    exit 1
  else
    echo "âœ… MySQL ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
  fi

  db_temp=$(mktemp /tmp/db.remove.conf_tempfile.XXXXXX)

  echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ë° DB ì‚¬ìš©ì ì‚­ì œ ì¤‘..."
  {
    echo "DROP DATABASE \`$DB_NAME\`;"
    echo "DELETE FROM mysql.user WHERE User='$DB_USER';"
    echo "DELETE FROM mysql.db WHERE User='$DB_USER';"
    echo "FLUSH PRIVILEGES;"
  } >>"$db_temp"

  # MySQL ì¿¼ë¦¬ ì‹¤í–‰
  mysql -u "$DB_ROOT_USER" -p"$DB_ROOT_PASSWORD" <"$db_temp"
  if [ $? -eq 0 ]; then
    echo "âœ… $DB_NAME ë°ì´í„°ë² ì´ìŠ¤ ë° $DB_USER ì‚¬ìš©ì ì‚­ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
  else
    echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ë° ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
    exit 1
  fi
fi

# ì„ì‹œíŒŒì¼ ìƒì„±
# db_temp=$(mktemp /tmp/db.remove.conf_tempfile.XXXXXX)
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     DB ì‚­ì œì²˜ë¦¬                           #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# # vhost ì‚­ì œ (ê°€ìƒ í˜¸ìŠ¤íŠ¸ ì„¤ì • íŒŒì¼ì—ì„œ í•´ë‹¹ ê³„ì • ì£¼ì„ ì²˜ë¦¬)
# echo "vhost ì„¤ì •ì—ì„œ $USER_ACCOUNT ê°€ìƒ í˜¸ìŠ¤íŠ¸ ì£¼ì„ ì²˜ë¦¬ ì¤‘..."
# vhost_lines=$($BIN -S | grep "$USER_ACCOUNT" | grep namevhost | awk '{ print $5 }' | sed 's/[()]//g')
# # vhost_line=$($BIN -S | grep "$USER_ACCOUNT" | grep namevhost | awk '{ print $5 }' | sed 's/[()]//g' | cut -d':' -f2)
# if [ -n "$vhost_lines" ]; then
#     # sed -i.bak "${vhost_line},/<\/VirtualHost>/ s/^/#/" "$VHOST_CONF_NAME"
#     # echo "âœ… vhost ì„¤ì •ì—ì„œ $USER_ACCOUNT ê°€ìƒ í˜¸ìŠ¤íŠ¸ë¥¼ ì£¼ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤."
#     for vhost_line in $vhost_lines; do
#         # íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
#         path=$(echo "$vhost_line" | awk -F':' '{print $1}')
#         # ë¼ì¸ ë²ˆí˜¸ ì¶”ì¶œ
#         line=$(echo "$vhost_line" | awk -F':' '{print $2}')
#         echo "âœ… íŒŒì¼ ê²½ë¡œ: $vhost_line"
#         if [ -f "$path" ]; then
#             # í•´ë‹¹ ë¼ì¸ë¶€í„° VirtualHost ì¢…ë£Œê¹Œì§€ ì£¼ì„ ì²˜ë¦¬
#             sed -i.bak "${line},/<\/VirtualHost>/ s/^/#/" "$path"
#             echo "âœ… $path íŒŒì¼ì—ì„œ $USER_ACCOUNT ê°€ìƒ í˜¸ìŠ¤íŠ¸ë¥¼ ì£¼ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤."
#         else
#             echo "â—ï¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $path"
#             exit 1
#         fi
#     done
# else
#     echo "â—ï¸ vhost ì„¤ì •ì—ì„œ $USER_ACCOUNT ê°€ìƒ í˜¸ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
#     exit 1
# fi

# # cband ì‚­ì œ (cband.confì—ì„œ í•´ë‹¹ ê³„ì • ê´€ë ¨ ì„¤ì • ì£¼ì„ ì²˜ë¦¬)
# echo "CBand ì„¤ì •ì—ì„œ $USER_ACCOUNT ì‚¬ìš©ì ì„¤ì • ì£¼ì„ ì²˜ë¦¬ ì¤‘..."
# if grep -q "<CBandUser cband$USER_ACCOUNT>" "$CBAND_CONF_NAME"; then
#     sed -i.bak "/<CBandUser cband$USER_ACCOUNT>/,/<\/CBandUser>/ s/^/#/" "$CBAND_CONF_NAME"
#     echo "âœ… CBand ì„¤ì •ì—ì„œ $USER_ACCOUNT ì‚¬ìš©ì ì„¤ì •ì„ ì£¼ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤."
# else
#     echo "â—ï¸ CBand ì„¤ì •ì—ì„œ $USER_ACCOUNT ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
#     exit 1
# fi

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     vhost ì£¼ì„ ì²˜ë¦¬                         #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
vhost_head=($(grep -n "\<VirtualHost" "$VHOST_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

vhost_tail=($(grep -n "</VirtualHost>" "$VHOST_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

vhost_line=$(grep -n "DocumentRoot $HOME_DIR/$USER_ACCOUNT/www" "$VHOST_CONF_NAME" | awk '{ print $1 }' | head -n 1 | cut -d':' -f1)

closest_smaller_in_vhost_head=$(find_closest_smaller $vhost_line "${vhost_head[@]}")

closest_larger_in_vhost_tail=$(find_closest_larger $vhost_line "${vhost_tail[@]}")

if [ $closest_smaller_in_vhost_head -eq -1 ]; then
  echo "âŒ vhost ì£¼ì„ ì²˜ë¦¬: vhost_headì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ ì‘ì€ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

if [ $closest_larger_in_vhost_tail -eq -1 ]; then
  echo "âŒ vhost ì£¼ì„ ì²˜ë¦¬: vhost_tailì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ í° ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

echo "âœ… vhost ì£¼ì„ ì²˜ë¦¬: ${closest_smaller_in_vhost_head} < ${vhost_line} < ${closest_larger_in_vhost_tail}"
# ë””ë²„ê¹…ìš© ì¶œë ¥
# sed -n "${closest_smaller_in_vhost_head},${closest_larger_in_vhost_tail}p" $VHOST_CONF_NAME
sed -i "${closest_smaller_in_vhost_head},${closest_larger_in_vhost_tail}s/^/# /" "$VHOST_CONF_NAME"
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     vhost ì£¼ì„ ì²˜ë¦¬                         #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     Cband ì£¼ì„ ì²˜ë¦¬                         #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
cband_head=($(grep -n "\<IfModule" "$CBAND_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

cband_tail=($(grep -n "</IfModule>" "$CBAND_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

cband_line=$(grep -n "<CBandUser cband$USER_ACCOUNT>" "$CBAND_CONF_NAME" | awk '{ print $1 }' | head -n 1 | cut -d':' -f1)

closest_smaller_in_cband_head=$(find_closest_smaller $cband_line "${cband_head[@]}")

closest_larger_in_cband_tail=$(find_closest_larger $cband_line "${cband_tail[@]}")

if [ $closest_smaller_in_cband_head -eq -1 ]; then
  echo "âŒ Cband ì£¼ì„ ì²˜ë¦¬: cband_headì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ ì‘ì€ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

if [ $closest_larger_in_cband_tail -eq -1 ]; then
  echo "âŒ Cband ì£¼ì„ ì²˜ë¦¬: cband_tailì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ í° ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi
echo "âœ… Cband ì£¼ì„ ì²˜ë¦¬: ${closest_smaller_in_cband_head} < ${cband_line} < ${closest_larger_in_cband_tail}"
# ë””ë²„ê¹…ìš© ì¶œë ¥
# sed -n "${closest_smaller_in_cband_head},${closest_larger_in_cband_tail}p" $CBAND_CONF_NAME
sed -i "${closest_smaller_in_cband_head},${closest_larger_in_cband_tail}s/^/# /" "$CBAND_CONF_NAME"
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     cband ì£¼ì„ ì²˜ë¦¬                         #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     ssl ì£¼ì„ ì²˜ë¦¬                           #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
ssl_head=($(grep -n "\<VirtualHost" "$SSL_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

ssl_tail=($(grep -n "</VirtualHost>" "$SSL_CONF_NAME" | awk '{ print $1 }' | cut -d':' -f1))

# DocumentRoot ë¼ì¸ì„ ì°¾ëŠ” ë¶€ë¶„, ë§Œì•½ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë˜ ë¡œì§ì„ ê±´ë„ˆëœ€
ssl_line=$(grep -n "DocumentRoot $HOME_DIR/$USER_ACCOUNT/www" "$SSL_CONF_NAME" | awk '{ print $1 }' | head -n 1 | cut -d':' -f1)

# ssl_lineì´ ë¹„ì–´ìˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ë¡œì§ì„ ê±´ë„ˆëœ€
if [ -z "$ssl_line" ]; then
  echo "ğŸ”” ssl ì£¼ì„ ì²˜ë¦¬: DocumentRootê°€ $SSL_CONF_NAME ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ì„ ì²˜ë¦¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
else
  closest_smaller_in_ssl_head=$(find_closest_smaller $ssl_line "${ssl_head[@]}")
  closest_larger_in_ssl_tail=$(find_closest_larger $ssl_line "${ssl_tail[@]}")

  # ê²°ê³¼ ì¶œë ¥
  if [ $closest_smaller_in_ssl_head -eq -1 ]; then
    echo "âŒ ssl ì£¼ì„ ì²˜ë¦¬: ssl_headì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ ì‘ì€ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi

  if [ $closest_larger_in_ssl_tail -eq -1 ]; then
    echo "âŒ ssl ì£¼ì„ ì²˜ë¦¬: ssl_tailì—ì„œ ì…ë ¥ê°’ë³´ë‹¤ í° ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi

  echo "âœ… ssl ì£¼ì„ ì²˜ë¦¬: ${closest_smaller_in_ssl_head} < ${ssl_line} < ${closest_larger_in_ssl_tail}"
  # ë””ë²„ê¹…ìš© ì¶œë ¥
  # sed -n "${closest_smaller_in_ssl_head},${closest_larger_in_ssl_tail}p" $SSL_CONF_NAME
  sed -i "${closest_smaller_in_ssl_head},${closest_larger_in_ssl_tail}s/^/# /" "$SSL_CONF_NAME"
fi
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                           #
#                     ssl ì£¼ì„ ì²˜ë¦¬                           #
#                                                           #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# ì‚¬ìš©ì ì‚­ì œ ë° ë””ë ‰í† ë¦¬ ì •ë¦¬
echo "$USER_ACCOUNT ì‚¬ìš©ì ë° ê´€ë ¨ ë””ë ‰í† ë¦¬ ì‚­ì œ ì¤‘..."
/usr/sbin/userdel "$USER_ACCOUNT"
rm -rf "$HOME_DIR/$USER_ACCOUNT"
rm -rf "$LOG_DIR"
if [ $? -eq 0 ]; then
  echo "âœ… $USER_ACCOUNT ê³„ì • ë° ê´€ë ¨ ë””ë ‰í† ë¦¬ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."
else
  echo "â—ï¸ $USER_ACCOUNT ê³„ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
  exit 1
fi

echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ë° DB ì‚¬ìš©ì ì‚­ì œ ì¤‘..."
{
  echo "DROP DATABASE \`$DB_NAME\`;"
  echo "DELETE FROM mysql.user WHERE User='$DB_USER';"
  echo "DELETE FROM mysql.db WHERE User='$DB_USER';"
  echo "FLUSH PRIVILEGES;"
} >>"$db_temp"

# MySQL ì¿¼ë¦¬ ì‹¤í–‰
mysql -u "$DB_ROOT_USER" -p"$DB_ROOT_PASSWORD" <"$db_temp"
if [ $? -eq 0 ]; then
  echo "âœ… $DB_NAME ë°ì´í„°ë² ì´ìŠ¤ ë° $DB_USER ì‚¬ìš©ì ì‚­ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
else
  echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ë° ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
  exit 1
fi

# Apache ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì ìš©
echo "âœ… Apache ì„¤ì • íŒŒì¼ í…ŒìŠ¤íŠ¸ ì¤‘..."
$BIN -t
if [ $? -eq 0 ]; then
  echo "âœ… Apache ì„¤ì • íŒŒì¼ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. Apacheë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤."
  $BIN graceful # Apache ì¬ì‹œì‘
else
  echo "âŒ Apache ì„¤ì • íŒŒì¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”."
  exit 1
fi

# ì„ì‹œ íŒŒì¼ ì‚­ì œ
rm -rf "$db_temp"
echo "âœ… ì„ì‹œ íŒŒì¼ ì‚­ì œ ì™„ë£Œ. ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
